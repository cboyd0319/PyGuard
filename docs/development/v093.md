# PyGuard v0.9.3 - AI/ML Auto-Fix Group B: Context & Token Manipulation

**Version:** 0.9.3
**Phase:** Phase 6 - Auto-Fix & Remediation (Group B Implementation)
**Target:** Implement 6 additional auto-fixes for context and token manipulation attacks
**Status:** ðŸš€ In Progress
**Started:** 2025-10-27
**Completed:** TBD

## Progress Overview

**Previous State (v0.9.2):** 25/510 auto-fixes (5%)
**Current State:** 25/510 auto-fixes (5%) - Starting Group B
**Target State:** 31/510 auto-fixes (6%)
**Phase 1 Progress:** 25/80 fixes complete (31%)

## Phase 6.2 Objective

Complete **Group B: Context & Token Manipulation** with 6 safe fixes covering advanced prompt injection patterns.

### Goal
Implement automatic remediation for:
- Escape sequence injection (AIML019)
- Token stuffing attacks (AIML020)
- Recursive prompt injection (AIML021)
- Template literal injection (AIML026)
- F-string injection (AIML027)
- Variable substitution attacks (AIML028)

## Current Implementation Status

### Completed Auto-Fixes (25/80 Phase 1)

#### Foundation Fixes (17 fixes)
- âœ… PyTorch model loading security
- âœ… Hugging Face trust parameters
- âœ… API security basics
- âœ… GPU memory limits
- âœ… Model versioning
- âœ… Basic prompt injection

#### Group A: Delimiter & Encoding Attacks (8 fixes) âœ…
- âœ… AIML012: Unicode/homoglyph injection
- âœ… AIML013: Role confusion attacks (DAN mode)
- âœ… AIML014: Instruction concatenation
- âœ… AIML016: Markdown injection
- âœ… AIML017: XML/JSON injection
- âœ… AIML018: SQL comment injection
- âœ… AIML022: Base64 injection
- âœ… AIML023: ROT13 obfuscation

### Group B: Context & Token Manipulation (6 fixes) ðŸŽ¯

#### Implementation Plan

**Fix 1: AIML019 - Escape Sequence Injection**
- [ ] Detect newline sequences (\n\n\n) used to separate instructions
- [ ] Block escape sequences that manipulate prompt structure
- [ ] Sanitize control characters in user input
- [ ] Add warning comments for detection patterns

**Fix 2: AIML020 - Token Stuffing**
- [ ] Detect attempts to exhaust context window
- [ ] Add max input length validation
- [ ] Warn about token counting before LLM calls
- [ ] Implement truncation strategies

**Fix 3: AIML021 - Recursive Prompt Injection**
- [ ] Detect prompts containing nested prompt instructions
- [ ] Block multi-level instruction embedding
- [ ] Validate prompt structure depth
- [ ] Add recursive pattern detection

**Fix 4: AIML026 - Template Literal Injection**
- [ ] Detect unsafe template literal usage
- [ ] Validate template string sources
- [ ] Add escaping for template variables
- [ ] Warn about user-controlled templates

**Fix 5: AIML027 - F-string Injection**
- [ ] Detect f-strings with user input
- [ ] Validate f-string variable sources
- [ ] Add safe formatting alternatives
- [ ] Block code execution in f-strings

**Fix 6: AIML028 - Variable Substitution**
- [ ] Detect variable substitution attacks
- [ ] Validate substitution patterns
- [ ] Add input sanitization for substitutions
- [ ] Warn about unvalidated variable replacement

## Testing Strategy

### Per Fix Requirements (Minimum 15 tests)
1. **Basic Detection (3 tests)**
   - Vulnerable pattern detection
   - Safe pattern acceptance
   - Edge case handling

2. **Fix Application (3 tests)**
   - Comment insertion correctness
   - Warning message accuracy
   - Multiple occurrences handling

3. **Framework Coverage (3 tests)**
   - OpenAI API patterns
   - Anthropic API patterns
   - Generic LLM patterns

4. **Integration (3 tests)**
   - Real-world code scenarios
   - Multiple vulnerabilities
   - Complex nesting

5. **Regression (3 tests)**
   - Idempotency validation
   - No false positives
   - Preserves functionality

## Implementation Steps

### Step 1: Escape Sequence Injection (AIML019)
- [ ] Implement `_fix_escape_sequence_injection` function
- [ ] Detect \n\n\n patterns in user input assignments
- [ ] Add warning comments with detection patterns
- [ ] Write 15+ unit tests
- [ ] Validate against real prompts

### Step 2: Token Stuffing (AIML020)
- [ ] Implement `_fix_token_stuffing` function
- [ ] Detect large input without validation
- [ ] Add length check warnings
- [ ] Write 15+ unit tests
- [ ] Test with various LLM APIs

### Step 3: Recursive Prompt Injection (AIML021)
- [ ] Implement `_fix_recursive_prompt_injection` function
- [ ] Detect nested prompt patterns
- [ ] Add depth validation warnings
- [ ] Write 15+ unit tests
- [ ] Test complex nesting scenarios

### Step 4: Template Literal Injection (AIML026)
- [ ] Implement `_fix_template_literal_injection` function
- [ ] Detect template literal vulnerabilities
- [ ] Add escaping recommendations
- [ ] Write 15+ unit tests
- [ ] Cover JavaScript/Python templates

### Step 5: F-string Injection (AIML027)
- [ ] Implement `_fix_fstring_injection` function
- [ ] Detect unsafe f-string usage
- [ ] Add safe formatting alternatives
- [ ] Write 15+ unit tests
- [ ] Test Python-specific patterns

### Step 6: Variable Substitution (AIML028)
- [ ] Implement `_fix_variable_substitution` function
- [ ] Detect variable replacement attacks
- [ ] Add validation warnings
- [ ] Write 15+ unit tests
- [ ] Cover multiple substitution formats

## Success Metrics

**Technical Targets:**
- ðŸŽ¯ **6 new auto-fixes implemented**
- ðŸŽ¯ **90+ new unit tests** (15 per fix)
- ðŸŽ¯ **100% test pass rate**
- ðŸŽ¯ **31/80 Phase 1 progress** (39%)

**Quality Targets:**
- ðŸŽ¯ All fixes preserve code functionality
- ðŸŽ¯ All fixes include educational comments
- ðŸŽ¯ All fixes have OWASP references
- ðŸŽ¯ <5% false positive rate

## Timeline

**Estimated Duration:** 1 week for Group B
**Current Week:** Week 2-3 of auto-fix implementation

**Daily Breakdown:**
- Day 1: AIML019 (Escape sequences)
- Day 2: AIML020 (Token stuffing)
- Day 3: AIML021 (Recursive injection)
- Day 4: AIML026 (Template literals)
- Day 5: AIML027 (F-strings)
- Day 6: AIML028 (Variable substitution)
- Day 7: Integration testing & polish

## Next Steps

### Immediate Actions
1. âœ… Create v093.md progress document
2. Implement AIML019 escape sequence detection
3. Write comprehensive tests
4. Validate against real-world patterns
5. Commit and push progress

### Week 3 Deliverables
- [ ] 6 new auto-fixes for context/token attacks
- [ ] 90+ new tests (15 per fix)
- [ ] Updated documentation
- [ ] Performance validation

## References

- OWASP LLM Top 10 2023
- MITRE ATLAS Framework  
- Context Window Attacks Research
- Prompt Injection Taxonomy
- PyGuard Auto-Fix Architecture
- `docs/copilot/ai_ml.md` - Complete AI/ML plan
- `docs/development/v092.md` - Previous phase (Group A)

---

**Previous Phase:** See `v092.md` for Group A implementation (Delimiter & Encoding)
**Current Phase:** Implementing Group B (Context & Token Manipulation)
**Next Phase:** See `v094.md` for Group C (External Content Injection)

---

**Status:** ðŸš€ In Progress - Starting Group B implementation
**Achievement:** 25/80 Phase 1 fixes complete (31%), ahead of schedule
**Focus:** Context and token manipulation patterns (next 6 fixes)
