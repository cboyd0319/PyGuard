name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  packages: write
  id-token: write  # Required for OIDC attestations

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel release builds

defaults:
  run:
    shell: bash

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      packages: write
      id-token: write
      attestations: write  # Required for build provenance

    steps:
    - name: Checkout code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      with:
        fetch-depth: 1

    - name: Extract version from tag
      id: get_version
      shell: bash
      run: |
        set -euo pipefail
        VERSION="${GITHUB_REF#refs/tags/v}"
        echo "VERSION=${VERSION}" >> "${GITHUB_OUTPUT}"
        echo "Releasing version: ${VERSION}"

    - name: Set up Python
      uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
      with:
        python-version: '3.13'
        cache: 'pip'

    - name: Install dependencies
      shell: bash
      run: |
        set -euo pipefail
        python -m pip install --upgrade pip
        pip install build twine

    - name: Build package
      shell: bash
      run: |
        set -euo pipefail
        python -m build

    - name: Check package
      shell: bash
      run: |
        set -euo pipefail
        twine check dist/*

    - name: Generate SBOM (SPDX)
      uses: anchore/sbom-action@aa0e114b2e19480f157109b9922bda359bd98b90 # v0.20.8
      with:
        artifact-name: pyguard-${{ steps.get_version.outputs.VERSION }}.spdx.json
        output-file: pyguard-${{ steps.get_version.outputs.VERSION }}.spdx.json
        format: spdx-json

    - name: Generate SBOM (CycloneDX)
      shell: bash
      run: |
        set -euo pipefail
        pip install cyclonedx-bom
        cyclonedx-py --format json --output pyguard-${{ steps.get_version.outputs.VERSION }}.cyclonedx.json || true

    - name: Attest Build Provenance
      uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3.0.0
      with:
        subject-path: dist/*

    - name: Create Checksums
      shell: bash
      run: |
        set -euo pipefail
        cd dist
        sha256sum ./* > checksums.sha256
        cd ..

    - name: Sign artifacts with Sigstore
      uses: sigstore/gh-action-sigstore-python@f514d46b907ebcd5bedc05145c03b69c1edd8b46 # v3.0.0
      with:
        inputs: >-
          dist/*.tar.gz
          dist/*.whl
          pyguard-${{ steps.get_version.outputs.VERSION }}.spdx.json
          pyguard-${{ steps.get_version.outputs.VERSION }}.cyclonedx.json
          dist/checksums.sha256
        upload-signing-artifacts: true
        release-signing-artifacts: true

    - name: Import GPG key
      if: env.GPG_PRIVATE_KEY != ''
      shell: bash
      run: |
        set -euo pipefail
        echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
        echo "GPG key imported successfully"
      env:
        GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}

    - name: Sign artifacts with GPG
      if: env.GPG_PRIVATE_KEY != ''
      shell: bash
      run: |
        set -euo pipefail
        
        # Sign each distribution file
        for file in dist/*.tar.gz dist/*.whl; do
          if [ -f "$file" ]; then
            gpg --batch --yes --detach-sign --armor "$file"
            echo "Signed: $file"
          fi
        done
        
        # Sign SBOM files
        if [ -f "pyguard-${{ steps.get_version.outputs.VERSION }}.spdx.json" ]; then
          gpg --batch --yes --detach-sign --armor "pyguard-${{ steps.get_version.outputs.VERSION }}.spdx.json"
          echo "Signed: SPDX SBOM"
        fi
        
        if [ -f "pyguard-${{ steps.get_version.outputs.VERSION }}.cyclonedx.json" ]; then
          gpg --batch --yes --detach-sign --armor "pyguard-${{ steps.get_version.outputs.VERSION }}.cyclonedx.json"
          echo "Signed: CycloneDX SBOM"
        fi
        
        # Sign checksums
        if [ -f "dist/checksums.sha256" ]; then
          gpg --batch --yes --detach-sign --armor "dist/checksums.sha256"
          echo "Signed: checksums"
        fi
        
        echo "All artifacts signed with GPG"
      env:
        GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}

    - name: Export GPG public key
      if: env.GPG_PRIVATE_KEY != ''
      shell: bash
      run: |
        set -euo pipefail
        # Export public key for users to verify signatures
        gpg --armor --export > pyguard-pgp-public-key.asc
        echo "Public key exported to pyguard-pgp-public-key.asc"
      env:
        GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}

    - name: Publish to Test PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.TEST_PYPI_TOKEN }}
      shell: bash
      run: |
        set -euo pipefail
        twine upload --repository testpypi dist/* --skip-existing || true

    - name: Publish to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
      shell: bash
      run: |
        set -euo pipefail
        twine upload dist/*

    - name: Calculate SHA256 for Homebrew
      id: homebrew_sha
      shell: bash
      run: |
        set -euo pipefail
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        # Wait for PyPI to propagate (5 seconds usually enough)
        sleep 5
        # Download and calculate SHA256 of the source tarball
        SHA256=$(curl -sL "https://files.pythonhosted.org/packages/source/p/pyguard/pyguard-${VERSION}.tar.gz" | sha256sum | cut -d' ' -f1)
        echo "SHA256=${SHA256}" >> "${GITHUB_OUTPUT}"
        echo "Homebrew SHA256: ${SHA256}"

    - name: Update Homebrew formula
      shell: bash
      run: |
        set -euo pipefail
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        SHA256="${{ steps.homebrew_sha.outputs.SHA256 }}"
        
        # Update formula with new version and SHA256
        sed -i "s|pyguard-.*\.tar\.gz|pyguard-${VERSION}.tar.gz|g" homebrew/pyguard.rb
        sed -i "s|sha256 \".*\"|sha256 \"${SHA256}\"|g" homebrew/pyguard.rb
        
        # Configure git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Commit and push updated formula
        git add homebrew/pyguard.rb
        git commit -m "Update Homebrew formula to v${VERSION}" || echo "No changes to commit"
        git push origin HEAD:main || echo "Failed to push, continuing..."
        
        echo "Updated Homebrew formula to v${VERSION} (SHA256: ${SHA256})"

    - name: Notify Homebrew tap
      if: success()
      shell: bash
      run: |
        set -euo pipefail
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        SHA256="${{ steps.homebrew_sha.outputs.SHA256 }}"
        
        # Trigger update workflow in homebrew-pyguard tap (if it exists)
        # This step will fail gracefully if the tap repo doesn't exist yet
        curl -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          "https://api.github.com/repos/cboyd0319/homebrew-pyguard/dispatches" \
          -d "{\"event_type\":\"update-formula\",\"client_payload\":{\"version\":\"${VERSION}\",\"sha256\":\"${SHA256}\"}}" \
          || echo "Homebrew tap repository not yet created - formula updated in main repo"

    - name: Extract changelog
      id: changelog
      shell: bash
      run: |
        set -euo pipefail
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        # Extract the relevant section from docs/CHANGELOG.md
        awk "/## \[$VERSION\]/,/## \[/" docs/CHANGELOG.md | head -n -1 > release_notes.md || echo "See docs/CHANGELOG.md for details" > release_notes.md

    - name: Create GitHub Release
      uses: softprops/action-gh-release@6da8fa9354ddfdc4aeace5fc48d7f679b5214090 # v2.4.1
      with:
        files: |
          dist/*
          dist/checksums.sha256
          pyguard-${{ steps.get_version.outputs.VERSION }}.spdx.json
          pyguard-${{ steps.get_version.outputs.VERSION }}.cyclonedx.json
          dist/*.sig
          dist/*.crt
          dist/*.asc
          pyguard-${{ steps.get_version.outputs.VERSION }}.spdx.json.sig
          pyguard-${{ steps.get_version.outputs.VERSION }}.spdx.json.crt
          pyguard-${{ steps.get_version.outputs.VERSION }}.spdx.json.asc
          pyguard-${{ steps.get_version.outputs.VERSION }}.cyclonedx.json.sig
          pyguard-${{ steps.get_version.outputs.VERSION }}.cyclonedx.json.crt
          pyguard-${{ steps.get_version.outputs.VERSION }}.cyclonedx.json.asc
          dist/checksums.sha256.sig
          dist/checksums.sha256.crt
          dist/checksums.sha256.asc
          pyguard-pgp-public-key.asc
        body_path: release_notes.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Update major version tag
      shell: bash
      run: |
        set -euo pipefail
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        MAJOR_VERSION=$(echo "$VERSION" | cut -d. -f1)
        
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Delete old major version tag if it exists
        git push origin ":refs/tags/v${MAJOR_VERSION}" || true

        # Create and push new major version tag
        git tag -fa "v${MAJOR_VERSION}" -m "Update v${MAJOR_VERSION} to ${VERSION}"
        git push origin "v${MAJOR_VERSION}"
        
        echo "[OK] Updated v${MAJOR_VERSION} tag to point to v${VERSION}"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Add release summary
      if: success()
      shell: bash
      run: |
        {
          echo "## ðŸŽ‰ Release ${{ steps.get_version.outputs.VERSION }} Published"
          echo ""
          echo "### Package Information"
          echo "- **Version:** ${{ steps.get_version.outputs.VERSION }}"
          echo "- **PyPI:** https://pypi.org/project/pyguard/${{ steps.get_version.outputs.VERSION }}/"
          echo "- **GitHub Release:** ${{ github.server_url }}/${{ github.repository }}/releases/tag/${GITHUB_REF#refs/tags/}"
          echo ""
          echo "### Artifacts"
          echo "- [OK] Source distribution (sdist)"
          echo "- [OK] Wheel package (bdist_wheel)"
          echo "- [OK] SBOM - SPDX 2.3 format"
          echo "- [OK] SBOM - CycloneDX format"
          echo "- [OK] Build provenance attestation (SLSA)"
          echo "- [OK] SHA256 checksums"
          echo "- [OK] Sigstore signatures (.sig files)"
          echo "- [OK] Sigstore certificates (.crt files)"
          echo "- [OK] GPG signatures (.asc files)"
          echo "- [OK] GPG public key (for verification)"
          echo "- [OK] Homebrew formula updated"
          echo ""
          echo "### Installation"
          echo "**PyPI:** \`pip install pyguard==${{ steps.get_version.outputs.VERSION }}\`"
          echo ""
          echo "**Homebrew (v0.7.0+):** \`brew tap cboyd0319/pyguard && brew install pyguard\`"
          echo ""
          echo "### Security"
          echo "- Build provenance verifiable via GitHub attestations"
          echo "- All artifacts signed with Sigstore (keyless signing)"
          echo "- All artifacts signed with GPG (traditional signing)"
          echo "- Signatures recorded in Rekor transparency log"
          echo "- All dependencies audited by pip-audit, OSV-Scanner, Safety"
          echo "- Code scanned by Bandit, Semgrep, CodeQL"
          echo ""
          echo "### Verify Signatures"
          echo "\`\`\`bash"
          echo "# Verify with Sigstore (keyless)"
          echo "pip install sigstore"
          echo "sigstore verify github pyguard-${{ steps.get_version.outputs.VERSION }}.tar.gz \\"
          echo "  --cert-identity https://github.com/cboyd0319/PyGuard/.github/workflows/release.yml@refs/tags/v${{ steps.get_version.outputs.VERSION }} \\"
          echo "  --cert-oidc-issuer https://token.actions.githubusercontent.com"
          echo ""
          echo "# Verify with GPG (traditional)"
          echo "wget https://github.com/cboyd0319/PyGuard/releases/download/v${{ steps.get_version.outputs.VERSION }}/pyguard-pgp-public-key.asc"
          echo "gpg --import pyguard-pgp-public-key.asc"
          echo "gpg --verify pyguard-${{ steps.get_version.outputs.VERSION }}.tar.gz.asc pyguard-${{ steps.get_version.outputs.VERSION }}.tar.gz"
          echo "\`\`\`"
        } >> "${GITHUB_STEP_SUMMARY}"
