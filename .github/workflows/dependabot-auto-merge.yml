name: Dependabot Auto-Merge

on:
  pull_request:  # Correct event for Dependabot automation (per official docs)
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: dependabot-${{ github.event.pull_request.number }}
  cancel-in-progress: false  # Don't cancel Dependabot automation

defaults:
  run:
    shell: bash

jobs:
  dependabot:
    name: Dependabot Auto-Merge
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
      pull-requests: write
    # Only run for Dependabot PRs
    if: github.actor == 'dependabot[bot]'
    
    steps:
      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@08eff52bf64351f401fb50d4972fa95b9f2c2d1b # v2.4.0
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Enable auto-merge for patch and minor updates
        # Auto-merge for patch and minor updates only
        # Note: Approval will happen automatically via branch protection or repository settings
        if: |
          steps.metadata.outputs.update-type == 'version-update:semver-patch' ||
          steps.metadata.outputs.update-type == 'version-update:semver-minor'
        shell: bash
        run: |
          set -euo pipefail
          gh pr merge --auto --squash "${PR_URL}"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on major updates
        # Comment on major updates that require manual review
        if: steps.metadata.outputs.update-type == 'version-update:semver-major'
        shell: bash
        run: |
          set -euo pipefail
          gh pr comment "${PR_URL}" --body "âš ï¸ This is a **major version update** and requires manual review before merging."
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add summary
        if: always()
        shell: bash
        run: |
          {
            echo "## ðŸ¤– Dependabot Auto-Merge"
            echo ""
            echo "- **Update Type:** ${{ steps.metadata.outputs.update-type }}"
            echo "- **Package:** ${{ steps.metadata.outputs.dependency-names }}"
            echo ""
            if [[ "${{ steps.metadata.outputs.update-type }}" == "version-update:semver-major" ]]; then
              echo "âš ï¸ **Major update** - requires manual review"
            else
              echo "âœ… **Auto-merge enabled** for patch/minor update"
            fi
          } >> "${GITHUB_STEP_SUMMARY}"
